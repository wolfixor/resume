name: Terraform Arvan CI/CD

on:
  push:
    branches: [main, staging, dev]
  pull_request:
    branches: [main, staging, dev]

permissions:
  contents: read
  pull-requests: write

jobs:
  plan:
    name: Plan
    runs-on: ubuntu-latest
    outputs:
      tfplanExitCode: ${{ steps.tf-plan.outputs.exitcode }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_wrapper: false

    # - name: Setup Arvan CLI
    #   run: |
    #     curl -fsSL https://github.com/arvancloud/cli/releases/download/v1.3.6/arvan_1.3.6_linux_amd64.tar.gz | tar -xz
    #     sudo mv arvan /usr/local/bin/
    #     arvan auth login --api-key ${{ secrets.ARVAN_API_KEY }}a

    - name: Setup kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: Determine workspace
      id: workspace
      run: |
        case "${{ github.ref_name }}" in
          main) echo "workspace=prod" >> $GITHUB_OUTPUT ;;
          staging) echo "workspace=staging" >> $GITHUB_OUTPUT ;;
          dev) echo "workspace=dev" >> $GITHUB_OUTPUT ;;
          *) echo "workspace=dev" >> $GITHUB_OUTPUT ;;
        esac

    - name: Terraform Init
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY }}
      run: terraform init

    - name: Select Workspace
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY }}
      run: terraform workspace select ${{ steps.workspace.outputs.workspace }} || terraform workspace new ${{ steps.workspace.outputs.workspace }}

    - name: Terraform Plan
      id: tf-plan
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY }}
      run: |
        export exitcode=0
        terraform plan -var-file=env/${{ steps.workspace.outputs.workspace }}.tfvars -detailed-exitcode -no-color -out tfplan || export exitcode=$?
        echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
        if [ $exitcode -eq 1 ]; then
          echo Terraform Plan Failed!
          exit 1
        else 
          exit 0
        fi

    - name: Publish Terraform Plan
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-${{ steps.workspace.outputs.workspace }}
        path: tfplan

    - name: Create String Output
      id: tf-plan-string
      run: |
        TERRAFORM_PLAN=$(terraform show -no-color tfplan)
        delimiter="$(openssl rand -hex 8)"
        echo "summary<<${delimiter}" >> $GITHUB_OUTPUT
        echo "## Terraform Plan Output" >> $GITHUB_OUTPUT
        echo "<details><summary>Click to expand</summary>" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo '```terraform' >> $GITHUB_OUTPUT
        echo "$TERRAFORM_PLAN" >> $GITHUB_OUTPUT
        echo '```' >> $GITHUB_OUTPUT
        echo "</details>" >> $GITHUB_OUTPUT
        echo "${delimiter}" >> $GITHUB_OUTPUT

    - name: Publish Terraform Plan to Task Summary
      env:
        SUMMARY: ${{ steps.tf-plan-string.outputs.summary }}
      run: echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY

    - name: Comment PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          })
          const botComment = comments.find(comment => {
            return comment.user.type === 'Bot' && comment.body.includes('Terraform Plan Output')
          })
          const output = `#### Terraform Plan ðŸ“–\`${{ steps.tf-plan.outputs.exitcode }}\`
          <details><summary>Show Plan</summary>
          
          \`\`\`terraform
          ${{ steps.tf-plan-string.outputs.summary }}
          \`\`\`
          
          </details>
          
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workspace: \`${{ steps.workspace.outputs.workspace }}\`*`;
          
          if (botComment) {
            github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: output
            })
          } else {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
          }

  apply:
    name: Apply
    if: github.ref != 'refs/heads/main' || (github.event_name == 'push' && needs.plan.outputs.tfplanExitCode == 2)
    runs-on: ubuntu-latest
    environment: production
    needs: [plan]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    # - name: Setup Arvan CLI
    #   run: |
    #     curl -fsSL https://github.com/arvancloud/cli/releases/latest/download/arvan_linux_amd64.tar.gz | tar -xz
    #     sudo mv arvan /usr/local/bin/
    #     arvan auth login --api-key ${{ secrets.ARVAN_API_KEY }}

    - name: Setup kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: Determine workspace
      id: workspace
      run: |
        case "${{ github.ref_name }}" in
          main) echo "workspace=prod" >> $GITHUB_OUTPUT ;;
          staging) echo "workspace=staging" >> $GITHUB_OUTPUT ;;
          dev) echo "workspace=dev" >> $GITHUB_OUTPUT ;;
          *) echo "workspace=dev" >> $GITHUB_OUTPUT ;;
        esac

    - name: Terraform Init
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY }}
      run: terraform init

    - name: Select Workspace
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY }}
      run: terraform workspace select ${{ steps.workspace.outputs.workspace }} || terraform workspace new ${{ steps.workspace.outputs.workspace }}

    - name: Download Terraform Plan
      uses: actions/download-artifact@v4
      with:
        name: tfplan-${{ steps.workspace.outputs.workspace }}

    - name: Terraform Apply
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.ARVAN_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.ARVAN_SECRET_KEY }}
      run: terraform apply -auto-approve tfplan